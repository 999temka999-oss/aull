{% extends "base.html" %}
{% block title %}Dev Tools{% endblock %}
{% block content %}
<main class="container" style="padding: 20px;">
    <h2>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h2>
    
    <div style="margin: 20px 0;">
        <h3>üìã –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
        <button id="loadPlayersBtn" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="playersTable" style="background: #f5f5f5; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto;"></div>
    </div>
    
    <div style="margin: 20px 0;">
        <h3>üåæ –î–æ–±–∞–≤–∏—Ç—å –ø—à–µ–Ω–∏—Ü—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label>User ID: <input type="number" id="userId" value="1" min="1" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 80px;"></label>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <input type="number" id="wheatQuantity" value="100" min="1" max="1000" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px;"></label>
            <button id="addWheatBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">–î–æ–±–∞–≤–∏—Ç—å –ø—à–µ–Ω–∏—Ü—É</button>
        </div>
        <p id="result" style="margin-top: 10px;"></p>
    </div>
    
    <div style="margin: 20px 0;">
        <a href="/farm" style="padding: 8px 16px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏–≥—Ä–µ</a>
    </div>
</main>

<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
async function loadPlayers() {
    const btn = document.getElementById('loadPlayersBtn');
    const table = document.getElementById('playersTable');
    
    btn.disabled = true;
    btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    table.innerHTML = '<p>–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</p>';
    
    try {
        const response = await fetch('/api/dev/players', {
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.ok) {
            if (data.players.length === 0) {
                table.innerHTML = '<p>–ò–≥—Ä–æ–∫–æ–≤ –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #ddd; font-weight: bold;">';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">ID</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">–ò–º—è</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">Username</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">–ë–∞–ª–∞–Ω—Å</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">–ü–æ–ª—è</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">–°—Ç–∞—Ç—É—Å</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">–°–æ–∑–¥–∞–Ω</th>';
                html += '<th style="padding: 8px; border: 1px solid #ccc;">–î–µ–π—Å—Ç–≤–∏—è</th>';
                html += '</tr>';
                
                data.players.forEach(player => {
                    const inventoryText = Object.entries(player.inventory)
                        .map(([item, qty]) => `${item}: ${qty}`)
                        .join(', ') || '–ü—É—Å—Ç–æ';
                    
                    const statusText = player.is_blocked 
                        ? `üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω<br><small>${player.blocked_reason || '–ù–µ—Ç –ø—Ä–∏—á–∏–Ω—ã'}</small>`
                        : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω';
                    const rowStyle = player.is_blocked ? 'background: #ffebee;' : '';
                        
                    html += `<tr style="${rowStyle}">`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc; text-align: center;"><strong>${player.user_id}</strong></td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc;">${player.display_name}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc;">${player.username || '-'}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc; text-align: center;">${player.balance}üí∞</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc; text-align: center;">${player.fields_owned}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc; font-size: 12px;">${inventoryText}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc; font-size: 12px; text-align: center;">${statusText}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc; font-size: 12px;">${player.created_at}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ccc; text-align: center;">`;
                    
                    // –ö–Ω–æ–ø–∫–∞ –≤—ã–±—Ä–∞—Ç—å
                    html += `<button onclick="selectPlayer(${player.user_id}, '${player.display_name}')" style="padding: 4px 8px; background: #FF9800; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 12px; margin: 2px;">–í—ã–±—Ä–∞—Ç—å</button><br>`;
                    
                    // –ö–Ω–æ–ø–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                    if (player.is_blocked) {
                        html += `<button onclick="unblockUser(${player.user_id}, '${player.display_name}')" style="padding: 4px 8px; background: #4CAF50; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 12px; margin: 2px;">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
                    } else {
                        html += `<button onclick="blockUser(${player.user_id}, '${player.display_name}')" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 12px; margin: 2px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
                    }
                    
                    html += `</td>`;
                    html += '</tr>';
                });
                
                html += '</table>';
                table.innerHTML = html;
            }
        } else {
            table.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.error}</p>`;
        }
    } catch (error) {
        table.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
    }
    
    btn.disabled = false;
    btn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫';
}

// –í—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—à–µ–Ω–∏—Ü—ã
function selectPlayer(userId, displayName) {
    document.getElementById('userId').value = userId;
    document.getElementById('result').style.color = 'blue';
    document.getElementById('result').textContent = `‚úÖ –í—ã–±—Ä–∞–Ω –∏–≥—Ä–æ–∫: ${displayName} (ID: ${userId})`;
}

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function blockUser(userId, displayName) {
    const reason = prompt(`–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–≥—Ä–æ–∫–∞ "${displayName}":`, '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª');
    if (!reason) return;
    
    try {
        const response = await fetch('/api/dev/block_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ user_id: userId, reason })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            alert(`‚úÖ ${data.message}`);
            loadPlayers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
        }
    } catch (error) {
        alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
}

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function unblockUser(userId, displayName) {
    if (!confirm(`–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞ "${displayName}"?`)) return;
    
    try {
        const response = await fetch('/api/dev/unblock_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ user_id: userId })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            alert(`‚úÖ ${data.message}`);
            loadPlayers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
        }
    } catch (error) {
        alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadPlayers);

// –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
document.getElementById('loadPlayersBtn').addEventListener('click', loadPlayers);

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—à–µ–Ω–∏—Ü—ã
document.getElementById('addWheatBtn').addEventListener('click', async () => {
    const quantity = parseInt(document.getElementById('wheatQuantity').value) || 100;
    const userId = parseInt(document.getElementById('userId').value) || 1;
    const resultEl = document.getElementById('result');
    const btn = document.getElementById('addWheatBtn');
    
    btn.disabled = true;
    btn.textContent = '–î–æ–±–∞–≤–ª—è–µ–º...';
    resultEl.textContent = '';
    
    try {
        const response = await fetch('/api/action/dev/add_wheat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({ quantity, user_id: userId })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            resultEl.style.color = 'green';
            resultEl.textContent = `‚úÖ ${data.message}`;
        } else {
            resultEl.style.color = 'red';
            resultEl.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
        }
    } catch (error) {
        resultEl.style.color = 'red';
        resultEl.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
    }
    
    btn.disabled = false;
    btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—à–µ–Ω–∏—Ü—É';
});
</script>
{% endblock %}